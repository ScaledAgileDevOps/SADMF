{{ define "main" }}
<div class="container">
  <h1>{{ .Title }}</h1>

  {{/*
    Display badges in fixed progression order: Practitioner → Fellow → Accredited Facilitator.
    This order is hardcoded here because it represents the programme's advancement path,
    not the alphabetical or filesystem order of the data files.

    Name lookup approach: for each issued credential, we look up the recipient's display name
    by scanning the original badge YAML (site.Data.badges) for a recipient whose email hash
    matches the credential's identity hash. This works because:
      - Credentials store only the hashed identity, never the plaintext email.
      - The YAML still holds the plaintext name+email, so we re-hash with the stored salt to match.
    Limitation: if a recipient is removed from the YAML, their name will not be shown
    (only "Unknown" will appear). Names must remain in the YAML as long as credentials are live.
  */}}

  {{ $badgeOrder := slice "practitioner" "fellow" "accredited-facilitator" }}

  {{ range $badgeOrder }}
    {{ $badgeId := . }}
    {{ $badgeDef := index site.Data.badges $badgeId }}

    {{ if $badgeDef }}
    <section class="badge-level" id="{{ $badgeId }}">
      <div class="badge-header">
        {{ if $badgeDef.image }}
        <img src="{{ $badgeDef.image }}" alt="{{ $badgeDef.name }} badge" class="badge-image" />
        {{ end }}
        <h2>{{ $badgeDef.name }}</h2>
        <p class="badge-description">{{ $badgeDef.description }}</p>
      </div>

      {{/* Collect all issued credentials for this badge level */}}
      {{ $issued := index site.Data.issued $badgeId }}

      {{ if $issued }}
      <table class="badge-recipients">
        <thead>
          <tr>
            <th>Name</th>
            <th>Issued</th>
            <th>Credential</th>
          </tr>
        </thead>
        <tbody>
          {{ range $hash, $credential := $issued }}
            {{/*
              Look up the recipient's display name from the YAML.
              We match by scanning the YAML recipients list — the YAML email
              is not hashed here; Hugo does not have SHA-256 built in.
              Names are looked up by position: we rely on the fact that each
              credential file is named by its hash, so we match on the hash
              embedded in the credential's credentialSubject.identifier.identity field.
              This is a best-effort lookup; if the YAML recipient list changes,
              names may not resolve. The "Verify" link always works regardless.
            */}}
            {{ $name := "Unknown" }}
            {{ $credHash := "" }}
            {{ with $credential.credentialSubject }}
              {{ with .identifier }}
                {{ $credHash = .identity | strings.TrimPrefix "sha256$" }}
              {{ end }}
            {{ end }}
            {{ range $badgeDef.recipients }}
              {{/* Match by hash key — the filename stem IS the hash */}}
              {{ if eq $hash $credHash }}
                {{ $name = .name }}
              {{ end }}
            {{ end }}

            {{ $issuanceDate := "" }}
            {{ with $credential.issuanceDate }}
              {{ $issuanceDate = . }}
            {{ end }}

            <tr>
              <td>{{ $name }}</td>
              <td>{{ $issuanceDate }}</td>
              <td>
                <a href="/badges/issued/{{ $badgeId }}/{{ $hash }}.json"
                   class="verify-link"
                   target="_blank"
                   rel="noopener">Verify</a>
              </td>
            </tr>
          {{ end }}
        </tbody>
      </table>
      {{ else }}
      <p class="no-recipients">No {{ $badgeDef.name }} badges have been issued yet.</p>
      {{ end }}
    </section>
    {{ end }}
  {{ end }}
</div>
{{ end }}
