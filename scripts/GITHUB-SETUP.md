# GitHub Setup: Badge Issuance Workflow

## Repository secrets required

Set these in **Settings → Secrets and variables → Actions → Repository secrets**.

| Secret | Description | Example |
|---|---|---|
| `BADGE_SIGNING_KEY` | Ed25519 private key JWK (base64) | generated by `scripts/generate-key.js` |
| `BADGE_ISSUER_URL` | Public base URL of the site | `https://scaledagiledevops.com` |
| `BADGE_ISSUER_NAME` | Issuer display name | `Scaled Agile DevOps Maturity Framework` |
| `SADMF_DISPATCH_TOKEN` | PAT with `repo` scope for the private recipients repo | GitHub → Settings → Developer settings → PATs |
| `SMTP_HOST` | SMTP server hostname | `smtp.gmail.com` |
| `SMTP_PORT` | SMTP port (usually 587) | `587` |
| `SMTP_USER` | SMTP login (Gmail address) | `scaledagiledevops@gmail.com` |
| `SMTP_PASS` | Gmail app password (16 chars) | generate at myaccount.google.com/apppasswords |
| `SMTP_FROM` | From header including display name | `SADMF Badge Issuer <scaledagiledevops@gmail.com>` |

### Gmail app password

1. Go to **myaccount.google.com/apppasswords** (requires 2FA enabled)
2. Create a new app password named `SADMF Badge Bot`
3. Copy the 16-character code and store it as `SMTP_PASS`

## Branch protection

`main` requires signed commits. The workflow creates commits via the GitHub API
(`github-actions[bot]`), which GitHub marks as verified automatically — no GPG key needed.

Do **not** re-enable `git push` in the workflow; always use the GitHub API commit step.

## Workflow triggers

| Event | When it fires |
|---|---|
| `push` to `main` (paths: `data/badges/**.yaml`) | Badge definition changed |
| `repository_dispatch: recipients-updated` | Private recipients repo dispatches this event when a new recipient YAML is merged |

To trigger manually:
```bash
gh api repos/ScaledAgileDevOps/SADMF/dispatches -f event_type=recipients-updated
```

## How issuance works

1. **Run tests** — all 22 Vitest scenarios must pass
2. **Issue new badges** — reads badge YAMLs + private recipients, skips already-issued credentials, writes new ones to `data/issued/` and `static/badges/issued/`
3. **Send badge notifications** — reads `tmp/notifications.json` (written only for newly issued credentials), sends one email per record with the badge image embedded inline, then deletes the file
4. **Commit issued credentials** — uploads new credential files via GitHub API and creates a verified commit on `main`

## Adding a new recipient

Use `add-recipient.js` to add someone and trigger issuance in one step:

```bash
cd scripts
set -a && source ../.env && set +a

node add-recipient.js <badge-id> "<name>" <email> [issued-date]

# Example (date defaults to today if omitted):
node add-recipient.js accredited-facilitator "Jane Smith" jane@example.com 2026-02-19
```

**What it does:**
1. Clones the private recipients repo
2. Appends the new entry to `recipients/<badge-id>.yaml`
3. Commits and pushes to the private repo
4. Dispatches `recipients-updated` → triggers the issuance workflow → sends email

Duplicate check: if the email already exists under that badge, it exits with an error.

**Requires** `SADMF_DISPATCH_TOKEN` in `.env` (PAT with `repo` scope for the private recipients repo).

---

## Re-sending a notification email

Use `resend-notification.js` to resend to a single recipient without touching anyone else.

```bash
cd scripts

# 1. Find the recipient's credential hash (the filename without .json):
ls ../static/badges/issued/<badge-id>/
# e.g. sha256$4dc05ddb13ccf3f43a52ad393d2fa49faa.json → hash is sha256$4dc05ddb...

# 2. Load SMTP credentials and resend
set -a && source ../.env && set +a
node resend-notification.js <badge-id> <hash> <email> "Recipient Name"

# Full example:
node resend-notification.js accredited-facilitator \
  sha256\$4dc05ddb13ccf3f43a52ad393d2fa49faa8ece0089bba51856ec21722b3b65eb \
  bryan.finster@gmail.com "Bryan Finster"
```

This sends exactly one email and does not touch `tmp/notifications.json` or any credential files.

## Why existing recipients are never re-emailed

- `FileNotificationLog.notify()` is only called by `BadgeIssuer` after `store.write()`
- `store.write()` is only called when `store.exists()` returns `false`
- Once a credential file exists on disk, `store.exists()` always returns `true` for that recipient
- Therefore adding new recipients to the YAML never triggers notifications for existing ones
